# 变更日志

本文件记录该项目的重要变更。

## [v1.0.0] - 2025-09-22 🎉

### 🚀 首个稳定版本发布

经过全面的功能开发、测试验证和质量保证，dm-sqllog-parser v1.0.0 正式发布！这标志着项目从实验性工具升级为生产就绪的企业级解决方案。

### ✨ 核心功能完整实现

#### 📊 SQL 日志解析引擎
- **高性能解析器**：支持达梦数据库 SQL 日志的完整格式解析
- **智能多行拼接**：自动识别和合并跨行的 SQL 语句和参数
- **宽松验证模式**：支持不完整记录的解析，提高数据恢复率
- **编码容错处理**：智能处理各种字符编码问题和格式异常

#### 🗄️ 数据库集成系统
- **多数据库支持**：可扩展的数据库抽象层，当前支持 DuckDB
- **批量高性能写入**：优化的批量插入机制，处理速度达 4000+ 记录/秒
- **内存/磁盘双模式**：支持内存数据库（快速）和磁盘数据库（持久化）
- **自动索引优化**：智能创建索引提升查询性能

#### 🔧 错误处理与恢复
- **线程安全错误写入**：基于 JSONL 格式的详细错误记录系统
- **完整错误追踪**：包含文件路径、行号、错误原因和原始内容
- **多策略错误处理**：支持停止、继续或忽略错误的灵活处理策略

#### 🚀 高性能并行处理
- **多线程解析**：利用所有 CPU 核心进行并行文件处理
- **独立数据库架构**：每个线程使用独立数据库连接避免冲突
- **智能负载均衡**：动态分配处理任务，最大化资源利用率

#### 📤 多格式数据导出
- **JSON 导出**：结构化数据导出，便于程序处理
- **CSV 导出**：通用格式导出，便于 Excel 等工具分析
- **大文件优化**：支持大规模数据的高效导出

### 🎯 质量保证指标

#### ✅ 测试覆盖
- **51 个单元测试**：全面覆盖核心功能模块
- **2 个文档测试**：确保代码示例正确性
- **集成测试完整**：覆盖端到端处理流程
- **基准测试**：性能回归保护

#### 🔍 代码质量
- **零 Clippy 警告**：通过最严格的 Rust 代码质量检查
- **完整文档覆盖**：所有公共 API 都有详细文档和示例
- **错误处理完善**：全面的错误类型和恢复机制
- **内存安全保证**：利用 Rust 语言的内存安全特性

### 🛠️ 架构优势

#### 🏗️ 模块化设计
- **清晰分层架构**：解析层、数据层、应用层职责明确
- **高度可扩展**：支持新数据库、新格式的轻松集成
- **配置驱动**：灵活的 TOML 配置文件支持

#### ⚡ 性能优化
- **流式处理**：低内存占用处理大文件
- **批量操作**：优化的数据库批量插入
- **并行架构**：充分利用多核 CPU 性能

### 📋 使用场景

- **生产环境日志分析**：处理 GB 级别的 SQL 日志文件
- **数据库性能监控**：分析慢查询和执行统计
- **数据质量检查**：识别和修复日志格式问题
- **历史数据迁移**：批量处理归档日志数据

### 🚀 性能基准

基于标准测试环境的性能指标：
- **解析速度**：4000+ 记录/秒（多线程）
- **内存使用**：流式处理，低内存占用
- **并发支持**：支持 CPU 核心数的并行处理
- **错误恢复**：99%+ 的数据恢复率

### 💡 技术亮点

- **Rust 语言**：内存安全 + 高性能 + 并发安全
- **现代架构**：Trait 抽象 + 泛型 + 零成本抽象
- **工程实践**：完整 CI/CD + 文档 + 测试体系
- **企业级质量**：详细日志 + 错误追踪 + 性能监控

## [v0.4.0] - 2025-09-22

### ✨ 新功能

#### 🚀 格式验证与质量控制
- **严格参数验证**：实现严格的 EXECTIME/ROWCOUNT/EXEC_ID 参数验证，只有格式完整的记录才能进入数据库
- **智能多行拼接**：改进多行内容拼接逻辑，只在 description 的最后一行搜索参数，避免误匹配
- **格式错误检测**：当多行拼接后最后一行缺少必要参数时，正确识别为解析失败

#### 🔧 错误处理系统
- **线程安全错误写入**：实现基于 `Arc<Mutex<BufWriter>>` 的线程安全错误写入器
- **JSONL 格式输出**：错误信息以标准 JSON Lines 格式输出，便于程序化分析
- **详细错误追踪**：每个错误记录包含文件路径、行号、错误描述和原始内容
- **批量错误处理**：支持批量写入错误，减少锁争用和提高性能

#### 🎛️ 优雅停止控制
- **Ctrl-C 信号处理**：实现优雅的中断信号处理，安全退出所有工作线程
- **交互式停止**：支持在交互式终端中输入 "stop" 命令停止程序
- **线程安全停止标志**：使用 `Arc<AtomicBool>` 实现并发安全的停止控制
- **资源清理保证**：确保停止时正确清理数据库连接和临时文件

#### 📊 数据库处理改进
- **独立数据库策略**：每个文件使用独立的临时数据库，最后合并到主数据库
- **批量写入优化**：使用 DuckDB Appender API 实现高性能批量数据写入
- **事务安全性**：完整的事务支持，确保数据一致性
- **错误隔离**：单个文件的处理失败不影响其他文件

### 🏗️ 架构改进

#### 📁 代码结构优化
- **模块化设计**：完善的模块化架构，职责清晰分离
- **错误写入模块**：独立的 `error_writer.rs` 模块，专门负责错误信息的收集和输出
- **数据库抽象层**：完整的数据库抽象层，支持多种数据库后端
- **配置管理模块**：分层配置管理，支持多种配置源

#### � 文档与注释
- **全面中文文档**：所有主要模块和函数都有详细的中文注释和使用说明
- **架构设计说明**：详细的设计理念和实现原理文档
- **使用示例丰富**：提供完整的使用场景示例和最佳实践
- **API 文档完善**：每个公开接口都有完整的参数说明和返回值描述

#### �🔧 代码质量提升
- **零 Clippy 警告**：通过最严格的 Clippy 检查（all + pedantic + nursery + cargo）
- **函数重构**：拆分长函数，提高代码可读性和可维护性
- **类型安全**：充分利用 Rust 类型系统，避免运行时错误
- **测试覆盖完整**：包含单元测试、集成测试和性能基准测试

### ⚙️ 配置系统增强

#### 🎯 新增配置选项
```toml
[sqllog]
# 是否将解析错误写入文件
write_errors = true
# 错误输出文件路径
errors_out_path = "parse_errors.jsonl"
# 解析器线程数量
parser_threads = 4
# 块大小配置
chunk_size = 1000

[database]
# 是否使用内存数据库
use_in_memory = false
# 数据库文件路径
db_path = "dm_sqllog_parser.duckdb"

[export]
# 单文件大小限制（字节，不能为 0）
file_size_bytes = 104857600
```

#### 📋 配置验证
- **配置合法性检查**：启动时验证配置的合法性和一致性
- **错误配置处理**：对于不合法的配置值（如 file_size_bytes = 0）给出明确错误提示
- **默认值填充**：为所有配置项提供合理的默认值

### � 性能优化

#### 🚀 并发处理优化
- **独立数据库处理**：每个文件使用独立数据库，避免锁争用
- **批量数据写入**：使用 DuckDB Appender 实现高性能批量写入
- **异步错误写入**：错误写入不阻塞主解析流程
- **内存使用优化**：改进内存分配模式，减少不必要的内存开销

#### 📊 处理统计
- **详细处理统计**：记录处理文件数、记录数、错误数等详细统计信息
- **性能指标**：提供处理速度、内存使用等性能指标
- **进度反馈**：实时显示处理进度和状态信息

### 🔍 质量保证特性

#### ✅ 数据完整性
- **格式严格验证**：确保只有完全符合格式的记录进入数据库
- **错误完整记录**：所有解析失败的记录都能在错误文件中找到
- **数据库隔离**：格式异常的记录不会污染数据库数据

#### 🛡️ 错误处理策略
```json
// 错误文件示例格式
{
  "path": "sqllog/test.log",
  "line": 42,
  "error": "日志格式错误: 行42: missing EXECTIME pattern",
  "raw": "SELECT * FROM users\n这是一个格式错误的行"
}
```

#### 📋 处理流程
```text
文件发现 → 独立数据库处理 → 格式验证 → 批量写入 → 错误收集 → 结果合并
    ↓            ↓            ↓         ↓         ↓         ↓
 目录扫描    临时数据库创建   参数检查   事务写入   JSONL输出   数据库合并
 规则过滤    线程安全处理     错误识别   性能优化   错误统计   统计汇总
```

### 🧪 测试与验证

#### 📊 测试覆盖
- **单元测试**：覆盖所有核心功能模块
- **集成测试**：完整的端到端处理流程测试
- **错误处理测试**：各种异常情况的处理验证
- **并发安全测试**：多线程环境下的安全性验证

#### 🏆 性能基准
- **解析性能基准**：SQL 日志解析速度基准测试
- **数据库写入基准**：不同写入模式的性能对比
- **错误处理基准**：错误写入系统的性能测试

### ⚠️ 重要说明

#### 📋 功能状态
- ✅ **已完成功能**：
  - SQL 日志解析和多行拼接
  - 格式验证和错误检测
  - 错误信息收集和 JSONL 输出
  - 数据库批量写入和 CSV 导出
  - 优雅停止和并发控制

- 🚧 **开发中功能**：
  - Web 界面和 API 接口
  - 实时日志监控
  - 数据可视化和报表

#### 🔄 向后兼容性
- **配置完全兼容**：所有现有配置文件无需修改
- **API 稳定性**：核心 API 保持向后兼容
- **数据格式一致**：输出格式与之前版本保持一致

### 🛠️ 技术债务清理

#### 🧹 代码清理
- **移除过时代码**：清理不再使用的旧版本解析逻辑
- **重构长函数**：将复杂函数拆分为职责单一的小函数
- **优化数据结构**：改进数据结构设计，提高内存效率

#### 📚 文档更新
- **README 重写**：全面重写 README，提供清晰的功能说明和使用指南
- **配置示例更新**：更新配置示例，反映最新的配置选项
- **错误排查指南**：提供详细的错误排查和诊断指南

---

[v0.4.0]: https://github.com/guangl/dm-sqllog-parser/releases/tag/v0.4.0

## [v0.2.1] - 2025-09-20
### 新增
- 基于 DuckDB Appender 的 `Sqllog` 批量写入器，支持可配置的 chunk 大小。
- `IndexReport`：用于记录每个索引创建的耗时与错误信息。
- 新增 CLI 选项以 JSON 格式导出 `IndexReport`：`--duckdb-path`、`--duckdb-report`、`--duckdb-chunk-size`。
- 为 DuckDB 写入器和索引失败注入添加集成测试。
- 在 GitHub Actions 工作流中启用严格的 Clippy 检查（pedantic / nursery / cargo）。

### 变更
- `Sqllog` 中的数值字段迁移为带符号的 `i64`，数据库模式同步更新为 `BIGINT`。
- 更新 README 和文档，加入使用示例与 CI 状态徽章。

### 修复
- 解决 Clippy pedantic 报告的问题并进行若干小的重构。

[v0.2.1]: https://github.com/guangl/dm-sqllog-parser/releases/tag/v0.2.1

## [v0.3.0] - 2025-09-21
### 新增 / 调整
- 对用户可见的文档与日志进行中文化翻译：包括 `README.md`、`CHANGELOG.md`、`config.toml.example` 以及程序在运行时输出给用户或 CI 的部分日志信息（注意：仅替换字符串/注释，不改变代码标识符或逻辑）。
- 将包版本从 `0.1.0` 提升到 `0.3.0`。

### 兼容性说明
- 配置字段名、SQL 语句与导出格式 token 保持不变，现有 `config.toml` 文件应与本次发布兼容。

[v0.3.0]: https://github.com/guangl/dm-sqllog-parser/releases/tag/v0.3.0

## [v0.3.1] - 2025-09-22
### 新增 / 改进
- 增加流式（chunked）解析 API：提供 `Sqllog::parse_all` 与 `Sqllog::parse_in_chunks`，支持按行读取原始字节（保留 CR/LF）、分块回调（成功/错误回调分离）以降低内存占用并支持实时处理。
- 将原有解析逻辑拆分为更小的 helper，并移除过时的 `get_raw_line`，部分解析实现迁移到 `src/sqllog/*` 模块内以改善代码结构。
- 在 `config.toml` 中新增 `log.level` 配置，用于设置运行时的日志等级（支持：error/warn/info/debug/trace/off），并将该配置注入到日志初始化流程中。
- 更新并修复基准（benches）和单元测试以配合新的 API，新增针对分块解析的测试用例。

### 修复
- 解决空白段被误报为 Format 错误的问题（跳过仅包含空白/换行的段落）。
- 修复并通过 Clippy 的若干警告（包括格式化和字符比较的改进）。

### 重构
- 将大量老旧的 sqllog 解析和 IO 代码重构为多个文件（`io.rs`、`parser.rs`、`utils.rs`、`types.rs`），移除部分不再使用的 DuckDB 写入器代码。

### 兼容性说明
- 新增的解析 API 向后兼容大多数使用场景，但旧的 `from_file_with_errors` 等已被移除或替换，使用前请查看 API 文档并更新调用处。

[v0.3.1]: https://github.com/guangl/dm-sqllog-parser/releases/tag/v0.3.1
