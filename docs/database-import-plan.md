# æ•°æ®åº“å¯¼å…¥åŠŸèƒ½å¼€å‘è®¡åˆ’

## ğŸ“‹ å¼€å‘ç›®æ ‡

å®ç°å®Œæ•´çš„ DuckDB æ•°æ®åº“å¯¼å…¥åŠŸèƒ½ï¼Œä½¿ sqllog-analysis å·¥å…·èƒ½å¤Ÿï¼š
1. å°†è§£æçš„ sqllog æ•°æ®å­˜å‚¨åˆ° DuckDB æ•°æ®åº“
2. æ”¯æŒå†…å­˜å’Œç£ç›˜ä¸¤ç§æ•°æ®åº“æ¨¡å¼
3. æä¾›é«˜æ€§èƒ½çš„æ‰¹é‡æ’å…¥åŠŸèƒ½
4. æ”¯æŒå¤šç§æ•°æ®å¯¼å‡ºæ ¼å¼

## ğŸ¯ åŠŸèƒ½è§„åˆ’

### Phase 1: æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„
- [x] åˆ›å»º `DatabaseManager` åŸºç¡€ç»“æ„
- [ ] å®ç°æ•°æ®åº“è¿æ¥ç®¡ç†ï¼ˆå†…å­˜/ç£ç›˜æ¨¡å¼ï¼‰
- [ ] è®¾è®¡å’Œåˆ›å»º `sqllogs` è¡¨ç»“æ„
- [ ] æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### Phase 2: æ•°æ®æ’å…¥åŠŸèƒ½
- [ ] å®ç° DuckDB Appender API é›†æˆ
- [ ] å¼€å‘æ‰¹é‡æ’å…¥åŠŸèƒ½
- [ ] æ·»åŠ äº‹åŠ¡ç®¡ç†å’Œé”™è¯¯å¤„ç†
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†
- [ ] é›†æˆæµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•

### Phase 3: åº”ç”¨é›†æˆ
- [ ] ä¿®æ”¹ `app.rs` é›†æˆæ•°æ®åº“å†™å…¥
- [ ] åœ¨è§£æå›è°ƒä¸­æ·»åŠ æ•°æ®åº“æ’å…¥é€»è¾‘
- [ ] å¤„ç†è§£æå’Œæ’å…¥çš„é”™è¯¯åè°ƒ
- [ ] æ›´æ–°é…ç½®é€‰é¡¹å’ŒéªŒè¯

### Phase 4: æ•°æ®å¯¼å‡ºåŠŸèƒ½
- [ ] å®ç° CSV å¯¼å‡ºåŠŸèƒ½
- [ ] å®ç° JSON å¯¼å‡ºåŠŸèƒ½
- [ ] å®ç° Excel å¯¼å‡ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
- [ ] æ·»åŠ å¯¼å‡ºé…ç½®å’Œæ–‡ä»¶ç®¡ç†
- [ ] å¤šçº¿ç¨‹å¯¼å‡ºä¼˜åŒ–

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

```sql
CREATE TABLE IF NOT EXISTS sqllogs (
    -- åŸºç¡€å­—æ®µ
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    
    -- ä¼šè¯å’Œäº‹åŠ¡ä¿¡æ¯
    session_id BIGINT,
    transaction_id BIGINT,
    
    -- SQL ä¿¡æ¯
    sql_text TEXT NOT NULL,
    sql_hash VARCHAR(64), -- SQL æ–‡æœ¬çš„å“ˆå¸Œå€¼ç”¨äºå»é‡å’Œåˆ†ç»„
    
    -- å®¢æˆ·ç«¯ä¿¡æ¯
    app_name VARCHAR(255),
    client_ip INET,
    
    -- æ€§èƒ½æŒ‡æ ‡
    execution_time_ms BIGINT,
    rows_affected BIGINT,
    
    -- å…ƒæ•°æ®
    source_file VARCHAR(500),
    source_line_number BIGINT,
    
    -- ç´¢å¼•
    INDEX idx_timestamp (timestamp),
    INDEX idx_session_id (session_id),
    INDEX idx_sql_hash (sql_hash),
    INDEX idx_app_name (app_name)
);
```

### æ‰¹é‡æ’å…¥ç­–ç•¥

1. **åˆ†å—å¤„ç†**ï¼šå°†å¤§é‡æ•°æ®åˆ†æˆå°æ‰¹æ¬¡å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
2. **Appender API**ï¼šä½¿ç”¨ DuckDB çš„åŸç”Ÿ Appender è·å¾—æœ€ä½³æ€§èƒ½
3. **äº‹åŠ¡ç®¡ç†**ï¼šé€‚å½“çš„äº‹åŠ¡è¾¹ç•Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **é”™è¯¯æ¢å¤**ï¼šå¤±è´¥é‡è¯•å’Œéƒ¨åˆ†æˆåŠŸå¤„ç†

### æ€§èƒ½ä¼˜åŒ–è€ƒè™‘

1. **å¹¶å‘æ’å…¥**ï¼šå¤šçº¿ç¨‹å¹¶è¡Œæ’å…¥ä¸åŒæ–‡ä»¶çš„æ•°æ®
2. **å†…å­˜ç®¡ç†**ï¼šæ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œé¿å…å¤§é‡æ•°æ®å †ç§¯
3. **ç´¢å¼•ç­–ç•¥**ï¼šå…ˆæ’å…¥æ•°æ®å†åˆ›å»ºç´¢å¼•ï¼Œæé«˜æ’å…¥æ€§èƒ½
4. **å‹ç¼©ä¼˜åŒ–**ï¼šåˆ©ç”¨ DuckDB çš„åˆ—å¼å­˜å‚¨ä¼˜åŠ¿

## ğŸ“Š é…ç½®æ‰©å±•

éœ€è¦åœ¨ `config.toml` ä¸­æ·»åŠ çš„æ–°é…ç½®ï¼š

```toml
[database]
# æ•°æ®åº“æ–‡ä»¶è·¯å¾„
db_path = "sqllogs.duckdb"
# æ˜¯å¦ä½¿ç”¨å†…å­˜æ•°æ®åº“
use_in_memory = false
# æ‰¹é‡æ’å…¥çš„æ‰¹æ¬¡å¤§å°
batch_size = 1000
# æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç´¢å¼•åˆ›å»º
auto_create_indexes = true

[export]
# æ˜¯å¦å¯ç”¨å¯¼å‡ºåŠŸèƒ½
enabled = false
# å¯¼å‡ºæ ¼å¼ï¼šcsv/json/excel
format = "csv"
# å¯¼å‡ºæ–‡ä»¶è·¯å¾„
out_path = "exports/sqllogs.csv"
# æ˜¯å¦æŒ‰çº¿ç¨‹åˆ†åˆ«å¯¼å‡º
per_thread_out = false
# å•ä¸ªæ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰
file_size_bytes = 104857600  # 100MB
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- æ•°æ®åº“è¿æ¥ç®¡ç†æµ‹è¯•
- è¡¨ç»“æ„åˆ›å»ºå’ŒéªŒè¯æµ‹è¯•
- æ‰¹é‡æ’å…¥åŠŸèƒ½æµ‹è¯•
- é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µæµ‹è¯•

### é›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯æ•°æ®å¤„ç†æµç¨‹æµ‹è¯•
- å¤šçº¿ç¨‹å¹¶å‘æ’å…¥æµ‹è¯•
- å¤§æ•°æ®é‡æ€§èƒ½æµ‹è¯•
- å†…å­˜å’Œç£ç›˜æ¨¡å¼å¯¹æ¯”æµ‹è¯•

### åŸºå‡†æµ‹è¯•
- æ’å…¥æ€§èƒ½åŸºå‡†
- æŸ¥è¯¢æ€§èƒ½åŸºå‡†
- å†…å­˜ä½¿ç”¨åŸºå‡†
- ä¸å…¶ä»–å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

## ğŸ“… å¼€å‘æ—¶é—´çº¿

- **Week 1**: Phase 1 - æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„
- **Week 2**: Phase 2 - æ•°æ®æ’å…¥åŠŸèƒ½
- **Week 3**: Phase 3 - åº”ç”¨é›†æˆ
- **Week 4**: Phase 4 - æ•°æ®å¯¼å‡ºåŠŸèƒ½
- **Week 5**: æµ‹è¯•ã€ä¼˜åŒ–å’Œæ–‡æ¡£å®Œå–„

## ğŸ” éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šæ‰€æœ‰è§„åˆ’åŠŸèƒ½æ­£å¸¸å·¥ä½œ
2. **æ€§èƒ½è¦æ±‚**ï¼šèƒ½å¤„ç†å¤§é‡æ•°æ®ï¼ˆ100ä¸‡+ è®°å½•ï¼‰ä¸”æ€§èƒ½åˆç†
3. **ç¨³å®šæ€§**ï¼šé”™è¯¯å¤„ç†å®Œå–„ï¼Œæ— å†…å­˜æ³„æ¼
4. **æ˜“ç”¨æ€§**ï¼šé…ç½®ç®€å•ï¼Œæ–‡æ¡£é½å…¨
5. **æµ‹è¯•è¦†ç›–**ï¼šæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•è¦†ç›–ç‡ > 80%

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [DuckDB Rust API æ–‡æ¡£](https://docs.rs/duckdb/)
- [DuckDB SQL å‚è€ƒ](https://duckdb.org/docs/sql/introduction)
- [ç°æœ‰ä»£ç æ¶æ„æ–‡æ¡£](../README.md)